@model IEnumerable<ONT_3rdyear_Project.ViewModels.PatientDashboardViewModel>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@{
    ViewData["Title"] = "Patient Records";
}

@{
    var user = await UserManager.GetUserAsync(User);
    var roles = await UserManager.GetRolesAsync(user);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="/css/Nurse1Sister/PatientList.css" rel="stylesheet" />

<style>
    
</style>

@{
    var medicationController = User.IsInRole("Sister") ? "NurseSister" : "Nurse";
}

<div class="patients-wrapper">

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <i class="fas fa-user-md"></i>
                Navigation
            </h3>
        </div>
        <nav class="sidebar-nav">
            <a asp-action="Vitals" class="nav-item">
                <i class="fas fa-heartbeat"></i>
                <span>Vitals</span>
            </a>
            <a asp-action="Treatments" class="nav-item">
                <i class="fas fa-stethoscope"></i>
                <span>Treatments</span>
            </a>
            <a href="@Url.Action(roles.Contains("Nurse") ? "Administered" : "ListAdministered", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-pills"></i>
                <span>Medications</span>
            </a>
            <a asp-action="InstructionList" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Instructions</span>
            </a>
            <a asp-action="Progress" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Progress</span>
            </a>
            <a href="@Url.Action("PatientsList", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item active">
                <i class="fas fa-users"></i>
                <span>Patients</span>
            </a>
            <a href="@Url.Action("Dashboard", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
        </nav>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
       

        <!-- Main Content -->
        <div class="patients-content">
            <div class="patients-header">
                
                <div class="title-section">
                    <h1 class="page-title">
                        <i class="fas fa-users"></i>
                        Patient Records
                    </h1>
                    <p class="page-subtitle">Manage and monitor all patient information and care activities</p>
                </div>
                @*                     </div> *@
                @* </div> *@
            </div>
            <div class="container">
                <!-- Search and Filter Section -->
                <div class="search-section">
                    <div class="search-input-group">
                        <input type="text" id="liveSearchInput" class="search-input" placeholder="🔍 Search by patient name..." autocomplete="off" />
                    </div>

                    <select id="wardFilter" class="filter-select">
                        <option value="">All Wards</option>
                        @foreach (var ward in ViewBag.Wards as SelectList)
                        {
                            <option value="@ward.Text">@ward.Text</option>
                        }
                    </select>

                    <select id="bedFilter" class="filter-select">
                        <option value="">All Beds</option>
                        @foreach (var bed in ViewBag.Beds as SelectList)
                        {
                            <option value="@bed.Text">@bed.Text</option>
                        }
                    </select>

                    <a asp-action="Dashboard" class="btn btn-dashboard">
                        <i class="fas fa-arrow-left"></i>
                        Back to Dashboard
                    </a>
                </div>

                   <!-- Patients Table -->
<div class="patients-cards-container">
    <div class="cards-header">
        <h3>
            <i class="fas fa-list"></i>
            Patient Records
            <small id="results-count" class="text-muted" style="font-size: 0.8rem; margin-left: 0.5rem;">
                (@Model.Count() patients)
            </small>
        </h3>
                        
                        <div class="sort-section" style="display: inline-block; margin-left: 1rem;">
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-sort"></i> Sort By
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" asp-action="PatientsList" asp-route-sortOrder="@ViewData["NameSortParm"]">
                                            Name @(ViewData["NameSortParm"]?.ToString() == "name_desc" ? "(Z-A)" : "(A-Z)")
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-action="PatientsList" asp-route-sortOrder="@ViewData["DateSortParm"]">
                                            Date @(ViewData["DateSortParm"]?.ToString() == "date_desc" ? "(Newest)" : "(Oldest)")
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
    </div>

    <div class="table-container">
        <table class="patients-table">
            <thead>
                <tr>
                    <th><i class="fas fa-user-injured"></i> Patient</th>
                    <th><i class="fas fa-door-closed"></i> Ward</th>
                    <th><i class="fas fa-bed"></i> Bed</th>
                    <th><i class="fas fa-heartbeat"></i> Status</th>
                    <th><i class="fas fa-cogs"></i> Actions</th>
                </tr>
            </thead>
            <tbody id="searchResults">
                @foreach (var patient in Model)
                {
                    <tr class="patient-row">
                        <td>
                            <div class="patient-info">
                                <div class="patient-avatar">
                                    @(patient.FirstName?.Substring(0, 1))@(patient.LastName?.Substring(0, 1))
                                </div>
                                <div class="patient-details">
                                    <div class="patient-name">@patient.FirstName @patient.LastName</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            @if (patient.Status == "Discharged")
                            {
                                <span class="detail-value">N/A</span>
                            }
                            else
                            {
                                <span class="ward-badge">@patient.WardName</span>
                            }
                        </td>
                        <td>
                            @if (patient.Status == "Discharged")
                            {
                                <span class="detail-value">N/A</span>
                            }
                            else
                            {
                                <span class="bed-badge">Bed @patient.BedNo</span>
                            }
                        </td>
                        <td>
                            @switch (patient.Status)
                            {
                                case "Admitted":
                                    <span class="badge bg-success">Admitted</span>
                                    break;
                                case "Discharged":
                                    <span class="badge bg-secondary">Discharged</span>
                                    break;
                                default:
                                    <span class="badge bg-danger">Not Admitted</span>
                                    break;
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                               @*  <a asp-controller="Nurse" asp-action="ViewAdvice" asp-route-patientId="@patient.PatientID" class="action-btn btn-view-instructions"
                                   onclick="return checkAdmission(@(patient.Status == "Admitted" ? "true" : "false"))">
                                    <i class="fas fa-eye"></i>
                                    <span>View Advice</span>
                                </a> *@
                                                <div class="notification-wrapper" style="position: relative; display: inline-block;">
                                                    <a asp-controller="Nurse" asp-action="ViewAdvice" asp-route-patientId="@patient.PatientID"
                                                       class="action-btn btn-view-instructions"
                                                       onclick="return checkAdmission(@(patient.Status == "Admitted" ? "true" : "false"));">
                                                        <i class="fas fa-eye"></i>
                                                        <span>View Advice</span>
                                                    </a>

                                                    <!-- Notification badge with clock icon -->
                                                    @if (patient.UnreadAdviceCount > 0)
                                                    {
                                                        <span class="notification-badge" id="badge-@patient.PatientID">
                                                            <i class="fa-solid fa-bell" style="margin-right: 2px;"></i>
                                                            @patient.UnreadAdviceCount
                                                        </span>
                                                    }
                                                </div>
                                <a asp-controller="Nurse" asp-action="CreateVital" asp-route-patientId="@patient.PatientID" class="action-btn btn-vitals">
                                    <i class="fas fa-heartbeat"></i>
                                    <span>Vitals</span>
                                </a>
                                <a asp-controller="Nurse" asp-action="CreateTreatment" asp-route-patientId="@patient.PatientID" class="action-btn btn-treatment"
                                   onclick="return checkAdmission(@(patient.Status == "Admitted" ? "true" : "false"))">
                                    <i class="fas fa-user-md"></i>
                                    <span>Treatment</span>
                                </a>
                                <a asp-controller="Nurse" asp-action="CreateAdminister" asp-route-patientId="@patient.PatientID" class="action-btn btn-medication"
                                   onclick="return checkAdmission(@(patient.Status == "Admitted" ? "true" : "false"))">
                                    <i class="fas fa-pills"></i>
                                    <span>Medication</span>
                                </a>
                                <a asp-controller="Nurse" asp-action="CreateRequest" asp-route-patientId="@patient.PatientID" class="action-btn btn-instructions"
                                   onclick="return checkAdmission(@(patient.Status == "Admitted" ? "true" : "false"))">
                                    <i class="fas fa-clipboard-list"></i>
                                    <span>Request Advice</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Loading patients...
    </div>
            </div>
        </div>
    </div>
</div>

<!-- Admission Warning Modal -->
<div class="modal fade" id="admissionModal" tabindex="-1" aria-labelledby="admissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="admissionModalLabel">
                    <i class="fas fa-exclamation-triangle"></i>
                    Action Not Allowed
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="admissionModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>

<script>
    const searchInput = document.getElementById('liveSearchInput');
    const wardFilter = document.getElementById('wardFilter');
    const bedFilter = document.getElementById('bedFilter');

         let searchTimeout;
        let currentSearchController;

        function performSearch() {
            // Cancel previous timeout
            clearTimeout(searchTimeout);

            // Cancel previous fetch request if it's still running
            if (currentSearchController) {
                currentSearchController.abort();
            }

            const query = searchInput.value.trim();
            const ward = wardFilter.value;
            const bed = bedFilter.value;

            // Create new AbortController for this request
            currentSearchController = new AbortController();

            // Add a small delay to prevent too many requests
            searchTimeout = setTimeout(() => {
                // Show loading state
                const tableBody = document.querySelector('#searchResults');
                const loadingSpinner = document.querySelector('.loading-spinner');
                tableBody.classList.add('loading');
                loadingSpinner.style.display = 'block';

                // Build query parameters
                const params = new URLSearchParams();

                if (query.length > 0) params.append('query', query);
                if (ward) params.append('ward', ward);
                if (bed) params.append('bed', bed);

                const url = params.toString()
                    ? `/Nurse/LiveSearch?${params.toString()}`
                    : `/Nurse/LiveSearchAll`;

                fetch(url, { signal: currentSearchController.signal })
                    .then(response => response.text())
                    .then(html => {
                        tableBody.innerHTML = html;
                        tableBody.classList.remove('loading');
                        loadingSpinner.style.display = 'none';

                        // Update results count
                        const resultCount = tableBody.querySelectorAll('.patient-row').length;
                        document.getElementById('results-count').textContent = `(${resultCount} patients)`;
                    })
                    .catch(error => {
                        if (error.name !== 'AbortError') {
                            console.error('Search failed:', error);
                            tableBody.classList.remove('loading');
                            loadingSpinner.style.display = 'none';
                        }
                    });
            }, 300); // 300ms delay
        }

    // Sidebar functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const mainContent = document.getElementById('mainContent');

    sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('show');
        sidebarToggle.classList.toggle('open');

        // On desktop, adjust main content margin
        if (window.innerWidth > 768) {
            mainContent.classList.toggle('sidebar-open');
        }
    });

    sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('show');
        sidebarToggle.classList.remove('open');
        mainContent.classList.remove('sidebar-open');
    });

    // Close sidebar on window resize if mobile
    window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
            mainContent.classList.remove('sidebar-open');
        }
    });

    // Add event listeners on input and selects
    searchInput.addEventListener('input', performSearch);
    wardFilter.addEventListener('change', performSearch);
    bedFilter.addEventListener('change', performSearch);

    function checkAdmission(isAdmitted) {
        isAdmitted = (isAdmitted === true || isAdmitted === 'true');
        if (!isAdmitted) {
            document.getElementById("admissionModalMessage").innerText =
                "Cannot perform this action. Patient is not admitted.";

            var modal = new bootstrap.Modal(document.getElementById('admissionModal'));
            modal.show();
            return false;
        }
        return true;
    }

          // Initialize results count
        document.addEventListener('DOMContentLoaded', function() {
            const resultCount = document.querySelectorAll('.patient-row').length;
            document.getElementById('results-count').textContent = `(${resultCount} patients)`;
        });


           
</script>