@model IEnumerable<ONT_3rdyear_Project.Models.PatientMedicationScript>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager


@{
    ViewData["Title"] = "Administered Medication";
}
@{
    var user = await UserManager.GetUserAsync(User);
    var roles = await UserManager.GetRolesAsync(user);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="~/css/Nurse1Sister/nonScheduled.css" rel="stylesheet" />
<!-- Ensure Bootstrap is loaded -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>




@if (TempData["SuccessMessage"] != null)
{
    <script>
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '@TempData["SuccessMessage"]',
            timer: 2000,
            showConfirmButton: false
        });
    </script>
}
@if (TempData["ErrorMessage"] != null)
{
    <script>
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: '@TempData["ErrorMessage"]',
            confirmButtonColor: '#d33',
            confirmButtonText: 'OK'
        });
    </script>
}



<div class="patients-wrapper">

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <i class="fas fa-user-md"></i>
                Navigation
            </h3>
        </div>
        <nav class="sidebar-nav">
            <a asp-action="Vitals" class="nav-item">
                <i class="fas fa-heartbeat"></i>
                <span>Vitals</span>
            </a>
            <a asp-action="Treatments" class="nav-item">
                <i class="fas fa-stethoscope"></i>
                <span>Treatments</span>
            </a>
            <a href="@Url.Action(roles.Contains("Nurse") ? "Administered" : "ListAdministered", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item active">
                <i class="fas fa-pills"></i>
                <span>Medications</span>
            </a>
            <a asp-action="InstructionList" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Instructions</span>
            </a>
            <a asp-action="Progress" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Progress</span>
            </a>
            <a href="@Url.Action("PatientsList", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Patients</span>
            </a>
            <a href="@Url.Action("Dashboard", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
        </nav>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">

    

    <!-- Header Section -->
  

      
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header Section -->
            <div class="patients-header">
                <div class="title-section">
                    <h1 class="page-title">
                        <i class="fas fa-pills"></i>
                        Administered Medications
                    </h1>
                    <p class="page-subtitle">Track and manage all administered medications and prescriptions</p>
                </div>
            </div>

            <!-- Main Content -->
            <div class="patients-content">
                <div class="container">
                    <!-- Search and Filter Section -->
                    <div class="search-section">
                        <form method="get" asp-action="Administered" class="search-form">
                            <div class="row mb-3 w-100">
                                @* <div class="col-md-4">
                                    <input type="text" name="searchPatient" class="form-control" placeholder="🔍 Search by patient name..." value="@ViewContext.HttpContext.Request.Query["searchPatient"]" />
                                </div> *@
                                <div class="col-md-4">
                                    <input type="text" id="realTimeSearch" name="searchPatient" class="form-control" placeholder="🔍 Search by patient name..." autocomplete="off" value="@ViewContext.HttpContext.Request.Query["searchPatient"]" />
                                </div>
                                <div class="col-md-3">
                                    <input type="date" name="fromDate" class="form-control" value="@ViewContext.HttpContext.Request.Query["fromDate"]" />
                                </div>
                                <div class="col-md-3">
                                    <input type="date" name="toDate" class="form-control" value="@ViewContext.HttpContext.Request.Query["toDate"]" />
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-funnel"></i>
                                        Filter
                                    </button>
                                </div>
                            </div>

                            
                        </form>
                    </div>

                    <!-- Content with side-by-side layout -->
                    <div class="content-with-chart">
                        <!-- Medications Table -->
                        <div class="patients-cards-container">
                            <div class="cards-header">
                                <h3>
                                    <i class="fas fa-pills"></i>
                                    Administered Medications
                                    <small id="results-count" class="text-muted" style="font-size: 0.8rem; margin-left: 0.5rem;">
                                        (@Model.Count() records)
                                    </small>
                                </h3>
                                <div class="header-right">
                                    <div class="sort-section" style="display: inline-block; margin-left: 16rem;">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-sort"></i> Sort By
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a class="dropdown-item" asp-action="Administered" asp-route-sortOrder="@ViewData["NameSortParm"]">
                                                        Name @(ViewData["NameSortParm"]?.ToString() == "name_desc" ? "(Z-A)" : "(A-Z)")
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" asp-action="Administered" asp-route-sortOrder="@ViewData["DateSortParm"]">
                                                        Date @(ViewData["DateSortParm"]?.ToString() == "date_desc" ? "(Newest)" : "(Oldest)")
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <a asp-action="AdministeredPdf" class="btn btn-danger pdf-btn">
                                        <i class="fas fa-file-pdf"></i>
                                        <span>Export PDF</span>
                                    </a>
                                </div>
                            </div>

                            <div class="table-container" id="searchResults">
                                <table class="patients-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-user"></i>
                                                    Patient Name
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-pills"></i>
                                                    Medication
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-prescription-bottle"></i>
                                                    Dosage
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-calendar"></i>
                                                    Date Administered
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-file-prescription"></i>
                                                    Prescription
                                                </span>
                                            </th>
                                            <th class="text-center">
                                                <span class="th-content">
                                                    <i class="fas fa-cog"></i>
                                                    Actions
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var treatment in Model)
                                        {
                                            <tr class="patient-row">
                                                <td>
                                                    <div class="patient-info">
                                                        <div class="patient-avatar">
                                                            @(treatment.Patient?.FirstName?.Substring(0, 1))@(treatment.Patient?.LastName?.Substring(0, 1))
                                                        </div>
                                                        <div class="patient-details">
                                                            <div class="patient-name">@treatment.Patient?.FirstName @treatment.Patient?.LastName</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge" style="background: rgba(0, 119, 190, 0.1); color: var(--primary-blue); padding: 0.375rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                                                        @treatment.Medication?.Name
                                                    </span>
                                                </td>
                                                <td>
                                                    <strong>@treatment.Dosage</strong>
                                                </td>
                                                <td>
                                                    <strong>@treatment.AdministeredDate.ToShortDateString()</strong>
                                                </td>
                                                <td>
                                                    @if (treatment.Prescription != null)
                                                    {
                                                        <a asp-action="DownloadPrescription" asp-route-id="@treatment.PrescriptionId" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-download"></i>
                                                           @*  Download PDF *@
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <div class="action-buttons">
                                                        <a asp-action="EditAdministered" asp-route-id="@treatment.Id" class="action-btn btn-treatment" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit Medication" data-has-prescription="@(treatment.PrescriptionId != null ? "true" : "false")">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <button class="action-btn delete-btn" data-id="@treatment.Id" data-name="@treatment.Patient?.FirstName" data-bs-toggle="modal" data-bs-target="#deleteModal" title="Delete Medication">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Chart container on the side -->
                        <div class="chart-container">
                            <h2>
                                <i class="bi bi-bar-chart-fill"></i>
                                Medication Analytics
                            </h2>
                            <canvas id="medicationsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete medication for <strong id="deletePatientName"></strong>? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="deleteMedicationId" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i>
                        Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

     // Sidebar functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const mainContent = document.getElementById('mainContent');

    sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('show');
        sidebarToggle.classList.toggle('open');

        // On desktop, adjust main content margin
        if (window.innerWidth > 768) {
            mainContent.classList.toggle('sidebar-open');
        }
    });

    sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('show');
        sidebarToggle.classList.remove('open');
        mainContent.classList.remove('sidebar-open');
    });

    // Close sidebar on window resize if mobile
    window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
            mainContent.classList.remove('sidebar-open');
        }
    });

    // Delete modal functionality
    var deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var MedicationId = button.getAttribute('data-id');
        var patientName = button.getAttribute('data-name');

        document.getElementById('deletePatientName').textContent = patientName;
        document.getElementById('deleteMedicationId').value = MedicationId;
        document.getElementById('deleteForm').action = '/Nurse/DeleteAdminister/' + MedicationId;
    });

    // Chart initialization
    const ctx = document.getElementById('medicationsChart');
    if (!ctx) {
        console.error('Canvas element not found!');
    } else {
        // Set explicit canvas size
        ctx.width = 400;
        ctx.height = 400;
        ctx.style.width = '100%';
        ctx.style.height = '400px';

        const chartData = {
            labels: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                                                        Model.GroupBy(m => m.Medication.Name)
                                                                            .Select(g => g.Key)
                                        )),
            datasets: [{
                label: 'Administered Count',
                data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                                                                        Model.GroupBy(m => m.Medication.Name)
                                                                                            .Select(g => g.Count())
                                        )),
                backgroundColor: [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                    '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
                ],
                borderColor: '#fff',
                borderWidth: 1,
                borderRadius: 6
            }]
        };

        new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '📊 Medications Administration Overview',
                        font: { size: 16, weight: 'bold' },
                        padding: { top: 10, bottom: 20 }
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 14 },
                        bodyFont: { size: 14 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Make sure chart is properly contained
        const canvas = document.getElementById('medicationsChart');
        if (canvas) {
            canvas.style.width = '100%';
            canvas.style.height = '100%';
        }
    }

        document.addEventListener('DOMContentLoaded', function() {
            // Add click event listeners to all edit buttons
            const editButtons = document.querySelectorAll('a[href*="EditAdministered"]');

            editButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    // You could check here if the medication has a prescription
                    // and prevent the default action if it does
                    const hasPrescription = this.getAttribute('data-has-prescription') === 'true';

                    if (hasPrescription) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Cannot Edit',
                            text: 'You cannot edit prescribed medication.',
                            confirmButtonColor: '#d33',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
        });
</script>

    <script>
        // Real-time search functionality for medications
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('realTimeSearch');
            let searchTimeout;

            // Function to perform search
            async function performSearch(searchTerm) {
                try {
                    // Show loading state
                    const tableBody = document.querySelector('.patients-table tbody');
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Searching...</td></tr>';

                    // Get current filter values
                    const fromDate = document.querySelector('input[name="fromDate"]').value;
                    const toDate = document.querySelector('input[name="toDate"]').value;
                    const sortOrder = '@ViewData["NameSortParm"]'; // Current sort order

                    // Build query parameters
                    const params = new URLSearchParams({
                        searchPatient: searchTerm,
                        sortOrder: sortOrder
                    });

                    if (fromDate) params.append('fromDate', fromDate);
                    if (toDate) params.append('toDate', toDate);

                    // Make the request to existing endpoint
                    const response = await fetch(`@Url.Action("Administered")?${params}`);
                    const text = await response.text();

                    // Extract just the table content from the response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newTableBody = doc.querySelector('.patients-table tbody');
                    const resultsCount = doc.querySelector('#results-count');

                    if (newTableBody) {
                        tableBody.innerHTML = newTableBody.innerHTML;

                        // Update results count if available
                        if (resultsCount) {
                            document.getElementById('results-count').innerHTML = resultsCount.innerHTML;
                        }
                    }

                } catch (error) {
                    console.error('Search error:', error);
                }
            }

            // Event listener for input
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim();

                // Clear previous timeout
                clearTimeout(searchTimeout);

                // Set new timeout (300ms delay)
                searchTimeout = setTimeout(() => {
                    if (searchTerm.length === 0 || searchTerm.length >= 2) {
                        performSearch(searchTerm);
                    }
                }, 300);
            });

            //  Handle Enter key for immediate search
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    performSearch(e.target.value.trim());
                }
            });
        });
    </script>
