@model IEnumerable<ONT_3rdyear_Project.Models.Vital>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@{
    ViewData["Title"] = "Vitals";
}
@{
    var user = await UserManager.GetUserAsync(User);
    var roles = await UserManager.GetRolesAsync(user);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="~/css/Nurse1Sister/VitalsList.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@if (TempData["SuccessMessage"] != null)
{
    <script>
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '@TempData["SuccessMessage"]',
            timer: 2000,
            showConfirmButton: false
        });
    </script>
}

<div class="patients-wrapper">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <i class="fas fa-user-md"></i>
                Navigation
            </h3>
        </div>
        <nav class="sidebar-nav">
            <a asp-action="Vitals" class="nav-item active">
                <i class="fas fa-heartbeat"></i>
                <span>Vitals</span>
            </a>
            <a asp-action="Treatments" class="nav-item">
                <i class="fas fa-stethoscope"></i>
                <span>Treatments</span>
            </a>
            <a href="@Url.Action(roles.Contains("Nurse") ? "Administered" : "ListAdministered", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-pills"></i>
                <span>Medications</span>
            </a>
            <a asp-action="InstructionList" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Instructions</span>
            </a>
             <a asp-action="Progress" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Progress</span>
            </a>
            <a href="@Url.Action("PatientsList", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Patients</span>
            </a>
            <a href="@Url.Action("Dashboard", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
        </nav>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
    
   

    <!-- Main Content -->
    <div class="patients-content">
         <div class="patients-header">
        
                <div class="title-section">
                    
                    <h1 class="page-title">

                        <i class="fas fa-heartbeat"></i>
                        Vitals Management
                    </h1>
                    <p class="page-subtitle">Monitor and track patient vital signs with comprehensive analytics</p>
                </div>
           
    </div>
        <div class="container">
            <!-- Search and Filter Section -->
            <div class="search-section">
                <form method="get" asp-action="Vitals" class="search-form">
                    <div class="row mb-3 w-100">
                       @*  <div class="col-md-4">
                            <input type="text" name="searchPatient" class="form-control" placeholder="🔍 Search by patient name..." />
                        </div> *@
                        <div class="col-md-4">
    <input type="text" 
           id="realTimeSearch" 
           name="searchPatient" 
           class="form-control" 
           placeholder="🔍 Search by patient name..." 
           autocomplete="off" />
</div>
                        <div class="col-md-3">
                            <input type="date" name="fromDate" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" name="toDate" class="form-control" />
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-funnel"></i>
                                Filter
                            </button>
                        </div>
                    </div>
                    
                   
                </form>
            </div>

            <!-- Content with side-by-side layout -->
            <div class="content-with-chart">
                <!-- Table container -->
                <!-- Vitals Table -->
<!-- Vitals Table -->
    <div class="patients-cards-container">
        <div class="cards-header">
            <h3>
                <i class="fas fa-heartbeat"></i>
                Vitals Records
                <small id="results-count" class="text-muted" style="font-size: 0.8rem; margin-left: 0.5rem;">
                    (@Model.Count() records)
                </small>
            </h3>
       
        
                <div class="sort-section" style="display: inline-block; margin-left: 40rem;">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sort"></i> Sort By
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" asp-action="Vitals" asp-route-sortOrder="@ViewData["NameSortParm"]">
                                    Name @(ViewData["NameSortParm"]?.ToString() == "name_desc" ? "(Z-A)" : "(A-Z)")
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" asp-action="Vitals" asp-route-sortOrder="@ViewData["DateSortParm"]">
                                    Date @(ViewData["DateSortParm"]?.ToString() == "date_desc" ? "(Newest)" : "(Oldest)")
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
          <div class="header-right">
            <a asp-action="VitalsPdf" class="btn btn-danger pdf-btn">
                <i class="fas fa-file-pdf"></i>
                <span>Export PDF</span>
            </a>
        </div>
    </div>
     

    <div class="table-container" id="searchResults">
        <table class="patients-table">
            <thead>
                <tr>
                    <th>
                        <span class="th-content">
                            <i class="fas fa-user"></i>
                            Patient Name
                        </span>
                    </th>
                    <th>
                        <span class="th-content">
                            <i class="fas fa-heartbeat"></i>
                            Blood Pressure
                        </span>
                    </th>
                    <th>
                        <span class="th-content">
                            <i class="fas fa-tint"></i>
                            Sugar Level
                        </span>
                    </th>
                    <th>
                        <span class="th-content">
                            <i class="fas fa-thermometer-half"></i>
                            Temperature
                        </span>
                    </th>
                    <th>
                        <span class="th-content">
                            <i class="fas fa-heartbeat"></i>
                            Pulse Rate
                        </span>
                    </th>
                    <th>
                        <span class="th-content">
                            <i class="fas fa-user-md"></i>
                            Taken By
                        </span>
                    </th>
                    <th>
                        <span class="th-content">
                            <i class="fas fa-clock"></i>
                            Date/Time
                        </span>
                    </th>
                    <th class="text-center">
                        <span class="th-content">
                            <i class="fas fa-cog"></i>
                            Actions
                        </span>
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var vital in Model)
                {
                    <tr class="patient-row">
                        <td>
                            <div class="patient-info">
                                <div class="patient-avatar">
                                    @(vital.Patient?.FirstName?.Substring(0, 1))@(vital.Patient?.LastName?.Substring(0, 1))
                                </div>
                                <div class="patient-details">
                                    <div class="patient-name">@vital.Patient?.FirstName @vital.Patient?.LastName</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <strong>@vital.BP</strong> <small class="text-muted">mmHg</small>
                        </td>
                        <td>
                            <strong>@vital.SugarLevel</strong> <small class="text-muted">mg/dL</small>
                        </td>
                        <td>
                            <strong>@vital.Temperature</strong> <small class="text-muted">°C</small>
                        </td>
                        <td>
                            <strong>@vital.PulseRate</strong> <small class="text-muted">bpm</small>
                        </td>
                        <td>
                            <strong>@vital.User?.FullName</strong>
                        </td>
                        <td>
                            <strong>@vital.Date</strong>
                        </td>
                        <td class="text-center">
                            <div class="action-buttons">
                                <a href="javascript:void(0);" class="action-btn delete-btn"
                                   data-bs-toggle="modal" data-bs-target="#deleteModal"
                                   data-id="@vital.VitalID"
                                   data-name="@vital.Patient?.FirstName @vital.Patient?.LastName"
                                   title="Delete Vital">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

                <!-- Chart container on the side -->
                @* <div class="chart-container">
                    <h2>
                        <i class="bi bi-bar-chart-fill"></i>
                        Vitals Analytics
                    </h2>
                    <canvas id="vitalsChart"></canvas>
                </div> *@
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete vital record for <strong id="deletePatientName"></strong>? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Sidebar functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const mainContent = document.getElementById('mainContent');

    sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('show');
        sidebarToggle.classList.toggle('open');
        
        // On desktop, adjust main content margin
        if (window.innerWidth > 768) {
            mainContent.classList.toggle('sidebar-open');
        }
    });

    sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('show');
        sidebarToggle.classList.remove('open');
        mainContent.classList.remove('sidebar-open');
    });

    // Close sidebar on window resize if mobile
    window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
            mainContent.classList.remove('sidebar-open');
        }
    });

    // Delete functionality (following the treatments pattern)
    document.addEventListener('DOMContentLoaded', function() {
        let deleteVitalId = null;
        let deleteRow = null;

        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                deleteVitalId = button.getAttribute('data-id');
                const patientName = button.getAttribute('data-name');

                document.getElementById('deletePatientName').textContent = patientName;
                deleteRow = button.closest('tr');
            });

            confirmDeleteBtn.addEventListener('click', function() {
                if (!deleteVitalId) return;

                fetch(`/Nurse/DeleteVital/${deleteVitalId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        if (deleteRow){
                            deleteRow.remove();
                        }
                        const modalInstance = bootstrap.Modal.getInstance(deleteModal);
                        modalInstance.hide();

                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Vital record successfully deleted.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        throw new Error('Delete failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to delete vital record.'
                    });
                });
            });
        }
    });

    // Chart functionality (if you uncomment the chart section)
    const patientData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
        Model.GroupBy(v => v.Patient?.FirstName + " " + v.Patient?.LastName)
             .Select(g => new {
                 PatientName = g.Key,
                 LatestBP = g.OrderByDescending(v => v.Date).FirstOrDefault()?.BP,
                 LatestPulse = g.OrderByDescending(v => v.Date).FirstOrDefault()?.PulseRate,
                 LatestSugar = g.OrderByDescending(v => v.Date).FirstOrDefault()?.SugarLevel,
                 LatestTemp = g.OrderByDescending(v => v.Date).FirstOrDefault()?.Temperature
             })
    ));

    // Process the data
    const patientNames = patientData.map(p => p.PatientName);
    
    const latestBP = patientData.map(p => {
        if (!p.LatestBP) return null;
        const parts = p.LatestBP.split('/');
        return parts.length > 0 ? parseInt(parts[0]) : null;
    });

    const latestPulse = patientData.map(p => p.LatestPulse);
    const latestSugar = patientData.map(p => p.LatestSugar);
    const latestTemp = patientData.map(p => p.LatestTemp);

    // Create the chart if canvas exists
    const chartCanvas = document.getElementById('vitalsChart');
    if (chartCanvas) {
        var ctx = chartCanvas.getContext('2d');
        
        window.vitalsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: patientNames,
                datasets: [
                    {
                        label: 'BP (Systolic)',
                        data: latestBP,
                        backgroundColor: '#EF4444',
                        borderColor: '#DC2626',
                        borderWidth: 1,
                        yAxisID: 'y',
                        categoryPercentage: 0.8,
                        barPercentage: 0.7
                    },
                    {
                        label: 'Pulse Rate',
                        data: latestPulse,
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        categoryPercentage: 0.8,
                        barPercentage: 0.7
                    },
                    {
                        label: 'Sugar Level',
                        data: latestSugar,
                        backgroundColor: '#3B82F6',
                        borderColor: '#1D4ED8',
                        borderWidth: 1,
                        yAxisID: 'y2',
                        categoryPercentage: 0.8,
                        barPercentage: 0.7
                    },
                    {
                        label: 'Temperature',
                        data: latestTemp,
                        backgroundColor: '#F59E0B',
                        borderColor: '#D97706',
                        borderWidth: 1,
                        yAxisID: 'y3',
                        categoryPercentage: 0.8,
                        barPercentage: 0.7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Latest Vital Signs by Patient',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return patientNames[context[0].dataIndex];
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (context.parsed.y !== null) {
                                    if (label.includes('BP')) label += ': ' + context.parsed.y + ' mmHg';
                                    else if (label.includes('Pulse')) label += ': ' + context.parsed.y + ' bpm';
                                    else if (label.includes('Sugar')) label += ': ' + context.parsed.y + ' mg/dL';
                                    else if (label.includes('Temp')) label += ': ' + context.parsed.y + ' °C';
                                    else label += ': ' + context.parsed.y;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'BP (mmHg)' },
                        min: 60,
                        max: 200
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Pulse (bpm)' },
                        min: 40,
                        max: 120,
                        grid: { drawOnChartArea: false }
                    },
                    y2: {
                        type: 'linear',
                        display: false,
                        title: { display: true, text: 'Sugar (mg/dL)' }
                    },
                    y3: {
                        type: 'linear',
                        display: false,
                        title: { display: true, text: 'Temp (°C)' }
                    },
                    x: {
                        display: false,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }
</script>
<script>
// Real-time search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('realTimeSearch');
    let searchTimeout;

    // Function to perform search
    async function performSearch(searchTerm) {
        try {
            // Show loading state
            const tableBody = document.querySelector('.patients-table tbody');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Searching...</td></tr>';

            // Get current filter values
            const fromDate = document.querySelector('input[name="fromDate"]').value;
            const toDate = document.querySelector('input[name="toDate"]').value;
            const sortOrder = '@ViewData["NameSortParm"]'; // Current sort order

            // Build query parameters
            const params = new URLSearchParams({
                searchPatient: searchTerm,
                sortOrder: sortOrder
            });
            
            if (fromDate) params.append('fromDate', fromDate);
            if (toDate) params.append('toDate', toDate);

            // Make the request to  existing endpoint
            const response = await fetch(`@Url.Action("Vitals")?${params}`);
            const text = await response.text();
            
            // Extract just the table content from the response
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const newTableBody = doc.querySelector('.patients-table tbody');
            const resultsCount = doc.querySelector('#results-count');
            
            if (newTableBody) {
                tableBody.innerHTML = newTableBody.innerHTML;
                
                // Update results count if available
                if (resultsCount) {
                    document.getElementById('results-count').innerHTML = resultsCount.innerHTML;
                }
            }
            
        } catch (error) {
            console.error('Search error:', error);
        }
    }

    // Event listener for input
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // Set new timeout (300ms delay)
        searchTimeout = setTimeout(() => {
            if (searchTerm.length === 0 || searchTerm.length >= 2) {
                performSearch(searchTerm);
            }
        }, 300);
    });

    // Optional: Handle Enter key for immediate search
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            performSearch(e.target.value.trim());
        }
    });
});
</script>