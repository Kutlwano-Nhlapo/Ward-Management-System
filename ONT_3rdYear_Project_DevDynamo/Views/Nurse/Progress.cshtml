@model ONT_3rdyear_Project.ViewModels.ProgressViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Patient Progress";
    var user = await UserManager.GetUserAsync(User);
    var roles = await UserManager.GetRolesAsync(user);
    var userFullName = $"{user.FullName}";
}


<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="/css/Nurse1Sister/Progress.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



<div class="patients-wrapper">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <i class="fas fa-user-md"></i>
                Navigation
            </h3>
        </div>
        <nav class="sidebar-nav">
            <a asp-action="Vitals" class="nav-item">
                <i class="fas fa-heartbeat"></i>
                <span>Vitals</span>
            </a>
            <a asp-action="Treatments" class="nav-item">
                <i class="fas fa-stethoscope"></i>
                <span>Treatments</span>
            </a>
            <a href="@Url.Action(roles.Contains("Nurse") ? "Administered" : "ListAdministered", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-pills"></i>
                <span>Medications</span>
            </a>
            <a asp-action="InstructionList" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Instructions</span>
            </a>
            <a asp-action="Progress" class="nav-item active">
                <i class="fas fa-chart-line"></i>
                <span>Progress</span>
            </a>
            <a href="@Url.Action("PatientsList", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Patients</span>
            </a>
            <a href="@Url.Action("Dashboard", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
        </nav>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Floating background elements -->
        <div class="floating-elements">
            <div class="floating-element"></div>
            <div class="floating-element"></div>
            <div class="floating-element"></div>
        </div>

        <!-- Header Section -->
        <div class="patients-header">
            
                    <div class="title-section">
                        <h1 class="page-title">
                            <i class="fas fa-chart-line"></i>
                            Patient Progress Report
                        </h1>
                        <p class="page-subtitle">Track and analyze patient health metrics and treatment progress over time</p>
                    </div>
                
        </div>

        <!-- Main Content -->
        <div class="patients-content">
            <div class="container">
                <!-- Filter Section -->
                <div class="filter-section">
                    <form method="get" class="filter-form">
                        <div class="row mb-3 w-100">
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-user"></i>
                                    Patient
                                </label>
                                @Html.DropDownList("patientId", Model.PatientsList, "-- Select patient --", new { @class = "form-select" })
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar-alt"></i>
                                    From Date
                                </label>
                                <input type="date" name="fromDate" class="form-control" value="@(Model.FromDate?.ToString("yyyy-MM-dd") ?? "")" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar-alt"></i>
                                    To Date
                                </label>
                                <input type="date" name="toDate" class="form-control" value="@(Model.ToDate?.ToString("yyyy-MM-dd") ?? "")" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-funnel"></i>
                                    Filter
                                </button>
                            </div>
                        </div>

                        <div class="d-flex gap-2 flex-wrap">
                            @* <a asp-controller="@(roles.Contains("Nurse") ? "Nurse" : "NurseSister")" asp-action="Dashboard" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Dashboard">
                                <i class="fas fa-home"></i>
                                Dashboard
                            </a>
                            <a asp-controller="@(roles.Contains("Nurse") ? "Nurse" : "NurseSister")" asp-action="PatientsList" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Back to List of Patients">
                                <i class="fas fa-users"></i>
                                Patient List
                            </a> *@
                            <button type="button" id="btnExportPDF" class="btn btn-danger">
                                <i class="fas fa-file-pdf"></i> Export Progress Report
                            </button>

                        </div>
                    </form>
                </div>

                <div id="progress-report-content">
                    <!-- Progress Chart Section -->
                    <div class="chart-section">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>
                                    <i class="fas fa-chart-line"></i>
                                    Progress Timeline
                                </h3>
                            </div>
                            <div class="chart-body">
                                <canvas id="progressChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Content Layout -->
                    <div class="content-layout">
                        <!-- Events Table -->
                        <div class="events-container">
                            <div class="events-card">
                                <div class="card-header">
                                    <h5>
                                        <i class="fas fa-calendar-check"></i>
                                        Events & Records Timeline
                                    </h5>
                                </div>
                                <div class="table-scroll-container">
                                    <table class="custom-table">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <span class="th-content">
                                                        <i class="fas fa-calendar"></i>
                                                        Date & Time
                                                    </span>
                                                </th>
                                                <th>
                                                    <span class="th-content">
                                                        <i class="fas fa-tag"></i>
                                                        Type
                                                    </span>
                                                </th>
                                                <th>
                                                    <span class="th-content">
                                                        <i class="fas fa-info-circle"></i>
                                                        Details
                                                    </span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                var events = new List<(DateTime date, string type, string detail)>();
                                                if (Model.Vitals != null) foreach (var v in Model.Vitals) events.Add((v.Date, "Vital", $"BP:{v.BP ?? "-"} / Pulse:{v.PulseRate} / Sugar:{v.SugarLevel} / Temp:{v.Temperature}"));
                                                if (Model.Medications != null) foreach (var m in Model.Medications) events.Add((m.AdministeredDate, "Medication", $"{m.Medication?.Name ?? "Med"} / Dosage: {m.Dosage ?? "-"}"));
                                                if (Model.Treatments != null) foreach (var t in Model.Treatments) events.Add((t.TreatmentDate, "Treatment", $"{t.TreatmentType ?? "Treatment"}"));
                                                var ordered = events.OrderByDescending(e => e.date).ToList();
                                            }

                                            @if (ordered.Any())
                                            {
                                                @foreach (var e in ordered)
                                                {
                                                    <tr class="event-row">
                                                        <td>
                                                            <div class="date-info">
                                                                <strong>@e.date.ToString("MMM dd, yyyy")</strong>
                                                                <small class="text-muted d-block">@e.date.ToString("HH:mm")</small>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="event-badge event-@e.type.ToLower()">
                                                                @if (e.type == "Vital")
                                                                {
                                                                    <i class="fas fa-heartbeat"></i>
                                                                }
                                                                else if (e.type == "Medication")
                                                                {
                                                                    <i class="fas fa-pills"></i>
                                                                }
                                                                else if (e.type == "Treatment")
                                                                {
                                                                    <i class="fas fa-stethoscope"></i>
                                                                }
                                                                @e.type
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="event-detail">
                                                                @e.detail
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted py-4">
                                                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                                        <div>No events found for the selected criteria</div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar Info -->
                        <div class="info-sidebar">
                            <!-- Summary Card -->
                            <div class="info-card">
                                <div class="card-header">
                                    <h5>
                                        <i class="fas fa-chart-pie"></i>
                                        Summary Statistics
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="stat-item">
                                        <div class="stat-icon vital-icon">
                                            <i class="fas fa-heartbeat"></i>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-number">@(Model.Vitals?.Count ?? 0)</div>
                                            <div class="stat-label">Vital Readings</div>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-icon medication-icon">
                                            <i class="fas fa-pills"></i>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-number">@(Model.Medications?.Count ?? 0)</div>
                                            <div class="stat-label">Medications</div>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-icon treatment-icon">
                                            <i class="fas fa-stethoscope"></i>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-number">@(Model.Treatments?.Count ?? 0)</div>
                                            <div class="stat-label">Treatments</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legend Card -->
                           
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>




@section Scripts {
    <script>
        // Sidebar functionality
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mainContent = document.getElementById('mainContent');

        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('show');
            sidebarToggle.classList.toggle('open');

            // On desktop, adjust main content margin
            if (window.innerWidth > 768) {
                mainContent.classList.toggle('sidebar-open');
            }
        });

        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');
            sidebarToggle.classList.remove('open');
            mainContent.classList.remove('sidebar-open');
        });

        // Close sidebar on window resize if mobile
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                mainContent.classList.remove('sidebar-open');
            }
        });

                // Chart.js implementation
        const labels = @Html.Raw(Model.ChartLabelsJson ?? "[]");
        const bpData = @Html.Raw(Model.BpJson ?? "[]");
        const pulseData = @Html.Raw(Model.PulseJson ?? "[]");
        const sugarData = @Html.Raw(Model.SugarJson ?? "[]");
        const tempData = @Html.Raw(Model.TempJson ?? "[]");

        const medData = @Html.Raw(Model.MedDataJson ?? "[]");
        const medTooltips = @Html.Raw(Model.MedTooltipsJson ?? "[]");

        const treatData = @Html.Raw(Model.TreatmentDataJson ?? "[]");
        const treatTooltips = @Html.Raw(Model.TreatmentTooltipsJson ?? "[]");

        // Chart.js config
        const ctx = document.getElementById('progressChart').getContext('2d');

        const data = {
            labels: labels,
            datasets: [
                {
                    label: 'BP (systolic)',
                    data: bpData,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239,68,68,0.15)',
                    yAxisID: 'y',
                    tension: 0.3,
                    spanGaps: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 2
                },
                {
                    label: 'Pulse Rate',
                    data: pulseData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16,185,129,0.12)',
                    yAxisID: 'y1',
                    tension: 0.3,
                    spanGaps: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 2
                },
                {
                    label: 'Sugar Level',
                    data: sugarData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59,130,246,0.12)',
                    yAxisID: 'y2',
                    tension: 0.3,
                    spanGaps: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 2,
                    hidden: true  // Hidden by default
                },
                {
                    label: 'Temperature',
                    data: tempData,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245,158,11,0.12)',
                    yAxisID: 'y3',
                    tension: 0.3,
                    spanGaps: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 2,
                    hidden: true  // Hidden by default
                },
                {
                    label: 'Medications',
                    data: medData,
                    type: 'line',
                    showLine: false,
                    pointStyle: 'rectRounded',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    backgroundColor: '#6b21a8',
                    borderColor: '#6b21a8',
                    yAxisID: 'y',
                },
                {
                    label: 'Treatments',
                    data: treatData,
                    type: 'line',
                    showLine: false,
                    pointStyle: 'triangle',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    backgroundColor: '#f97316',
                    borderColor: '#f97316',
                    yAxisID: 'y',
                }
            ]
        };

        const chart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,  // Changed to true for better context
                        text: 'Blood Pressure & Pulse Rate Timeline',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: 20
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'var(--primary-blue)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(items) {
                                if (!items || !items.length) return '';
                                return items[0].label;
                            },
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const v = context.parsed.y;
                                if (label === 'Medications') {
                                    const tips = medTooltips[context.dataIndex];
                                    if (tips && tips.length) return tips.join('\n');
                                    return 'Medication Event';
                                }
                                if (label === 'Treatments') {
                                    const tips = treatTooltips[context.dataIndex];
                                    if (tips && tips.length) return tips.join('\n');
                                    return 'Treatment Event';
                                }
                                // Generic formatting
                                if (v === null || v === undefined) return label + ': -';
                                if (label.includes('BP')) return label + ': ' + v + ' mmHg';
                                if (label.includes('Pulse')) return label + ': ' + v + ' bpm';
                                if (label.includes('Sugar')) return label + ': ' + v + ' mg/dL';
                                if (label.includes('Temp')) return label + ': ' + v + ' °C';
                                return label + ': ' + v;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 11
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date & Time',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Blood Pressure (mmHg)',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        suggestedMin: 60,  // Added suggested ranges for better scaling
                        suggestedMax: 200,
                        grid: {
                            color: 'rgba(239, 68, 68, 0.1)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return value + ' mmHg';  // Added units to ticks
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Pulse Rate (bpm)',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        suggestedMin: 40,  // Added suggested ranges
                        suggestedMax: 120,
                        grid: {
                            drawOnChartArea: false,
                            color: 'rgba(16, 185, 129, 0.1)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return value + ' bpm';  // Added units to ticks
                            }
                        }
                    },
                    y2: {
                        type: 'linear',
                        display: false,
                        title: { display: true, text: 'Sugar (mg/dL)' },
                    },
                    y3: {
                        type: 'linear',
                        display: false,
                        title: { display: true, text: 'Temperature (°C)' },
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    </script>
    <script>
        // Make the nurse name available to the PDF script
        const loggedInNurseName = '@userFullName';
    </script>

    <script>
                     document.getElementById("btnExportPDF").addEventListener("click", function () {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById("progress-report-content");

            // Get report information
            const patientSelect = document.querySelector('select[name="patientId"]');
            const selectedPatientText = patientSelect.options[patientSelect.selectedIndex]?.text || "All Patients";
            let patientName = "All Patients";
            if (selectedPatientText && selectedPatientText !== "-- Select patient --") {
                patientName = selectedPatientText;
            }

            const fromDate = document.querySelector('input[name="fromDate"]')?.value || "";
            const toDate = document.querySelector('input[name="toDate"]')?.value || "";
            const exportDate = new Date().toLocaleDateString();
            const exportTime = new Date().toLocaleTimeString();

            // Show loading indicator
            Swal.fire({
                title: 'Generating PDF...',
                text: 'This may take a few moments',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Company information
            const companyName = "DevDynamo";
            const companyAddress = "123 Medical Center, Healthcare City, 10001";
            const companyContact = "Tel: (555) 123-4567 | Email: info@devdynamo.com";

            // First, let's enhance the chart visibility before capturing
            enhanceChartForPDF();

            html2canvas(content, {
                scale: 3, 
                useCORS: true,
                logging: true, 
                backgroundColor: "#ffffff", // Force white background
                removeContainer: true,
                allowTaint: true,
                foreignObjectRendering: false,
                imageTimeout: 0, // No timeout for images
                onclone: function(clonedDoc) {
                    // Enhance the cloned document for better PDF rendering
                    enhanceElementsForPDF(clonedDoc);
                }
            }).then(canvas => {
                // Further enhance the canvas for better quality
                const enhancedCanvas = enhanceCanvasQuality(canvas);
                const imgData = enhancedCanvas.toDataURL("image/png", 1.0); // Maximum quality

                const pdf = new jsPDF("p", "mm", "a4");
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);

                let yPosition = margin;

               // Function to add header to all pages
            const addHeader = (pdf, pageNum) => {
                pdf.setDrawColor(100, 100, 100);
                pdf.setFillColor(255, 255, 255); // Pure white background
                pdf.rect(0, 0, pageWidth, 40, 'F');

            
            const logoUrl = '/images/Logo.jpg';
            const logoWidth = 40;
            const logoHeight = 10;
            const logoX = pageWidth / 2 - logoWidth / 2; // CENTER CALCULATION
            const logoY = 10;

            // Add logo image to PDF - CENTERED
            pdf.addImage(logoUrl, 'JPEG', logoX, logoY, logoWidth, logoHeight);

            // Company contact info - positioned below logo
            pdf.setFontSize(9);
            pdf.setTextColor(100, 100, 100);
            pdf.text(companyAddress, pageWidth / 2, logoY + logoHeight + 5, { align: "center" });
            pdf.text(companyContact, pageWidth / 2, logoY + logoHeight + 10, { align: "center" });

            // Report title
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0);
            pdf.text("PATIENT PROGRESS REPORT", pageWidth / 2, logoY + logoHeight + 18, { align: "center" });

            // Header separator line
            const separatorY = logoY + logoHeight + 25;
            pdf.setDrawColor(200, 200, 200);
            pdf.line(margin, separatorY, pageWidth - margin, separatorY);
        };

                // Function to add footer to all pages
                const addFooter = (pdf, pageNum, totalPages) => {
                    const footerY = pageHeight - 15;

                    // Footer separator line
                    pdf.setDrawColor(200, 200, 200);
                    pdf.line(margin, footerY - 10, pageWidth - margin, footerY - 10);

                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);

                    // Left: Confidential notice
                    pdf.text("CONFIDENTIAL MEDICAL DOCUMENT", margin, footerY - 5);

                    // Center: Page info
                    pdf.text(`Page ${pageNum} of ${totalPages}`, pageWidth / 2, footerY - 5, { align: "center" });

                    // Right: Generation info
                    pdf.text(`Generated: ${exportDate} ${exportTime}`, pageWidth - margin, footerY - 5, { align: "right" });

                    // Bottom line: Copyright/legal
                    pdf.setFontSize(7);
                    pdf.text(`© ${new Date().getFullYear()} ${companyName}. All rights reserved.`,
                            pageWidth / 2, footerY, { align: "center" });
                };

                // Function to add patient details section
                const addPatientDetails = (pdf, yStart) => {
                    let y = yStart;

                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text("PATIENT INFORMATION:", margin, y);
                    y += 6;

                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(9);

                    // Patient details in two columns
                    const col1 = margin;
                    const col2 = pageWidth / 2;

                    pdf.text(`Patient Name: ${patientName}`, col1, y);
                    pdf.text(`Report Period: ${fromDate && toDate ? `${fromDate} to ${toDate}` : 'All Time'}`, col2, y);
                    y += 4;

                    pdf.text(`Generated By: ${loggedInNurseName}`, col1, y);
                    pdf.text(`Report Date: ${exportDate}`, col2, y);
                    y += 4;

                    // Statistics summary
                    const vitalCount = document.querySelector('.stat-item:nth-child(1) .stat-number')?.textContent || '0';
                    const medCount = document.querySelector('.stat-item:nth-child(2) .stat-number')?.textContent || '0';
                    const treatmentCount = document.querySelector('.stat-item:nth-child(3) .stat-number')?.textContent || '0';

                    pdf.text(`Vital Readings: ${vitalCount}`, col1, y);
                    pdf.text(`Medications: ${medCount}`, col2, y);
                    y += 4;
                    pdf.text(`Treatments: ${treatmentCount}`, col1, y);

                    y += 8;

                    // Separator line
                    pdf.setDrawColor(200, 200, 200);
                    pdf.line(margin, y, pageWidth - margin, y);

                    return y + 5;
                };

                // First page setup
                addHeader(pdf, 1);
                yPosition = 50; // Start below header

                // Add patient details section
                yPosition = addPatientDetails(pdf, yPosition);

                // Calculate content dimensions
                const imgWidth = contentWidth;
                const imgHeight = (enhancedCanvas.height * imgWidth) / enhancedCanvas.width;

                // Add the main content with better quality
                pdf.addImage(imgData, "PNG", margin, yPosition, imgWidth, imgHeight, undefined, 'FAST');

                let heightLeft = imgHeight - (pageHeight - yPosition - 30);
                let currentPage = 1;

                // Add footer to first page
                addFooter(pdf, currentPage, 1);

                // Handle multiple pages
                while (heightLeft > 0) {
                    currentPage++;
                    pdf.addPage();

                    // Add header and footer to new page
                    //addHeader(pdf, currentPage);
                    addFooter(pdf, currentPage, currentPage + 1);

                    // Add remaining content
                    yPosition = -12;
                    pdf.addImage(imgData, "PNG", margin, yPosition - (imgHeight - heightLeft), imgWidth, imgHeight, undefined, 'FAST');

                    heightLeft -= (pageHeight - -12 - 30);
                }

                // Update total pages in all footers
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    addFooter(pdf, i, totalPages);
                }

                // Restore original chart appearance
                restoreOriginalChart();

                // Save the PDF
                const fileName = `Progress_Report_${patientName.replace(/\s+/g, "_")}_${exportDate.replace(/\//g, "-")}.pdf`;

                Swal.close();
                pdf.save(fileName);

            }).catch(error => {
                console.error('Error generating PDF:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Export Failed',
                    text: 'There was an error generating the PDF report. Please try again.'
                });
                restoreOriginalChart();
            });
        });

        // Function to enhance chart for better PDF visibility
        function enhanceChartForPDF() {
            const chart = Chart.getChart("progressChart");
            if (chart) {
                // Store original settings
                window.originalChartOptions = JSON.parse(JSON.stringify(chart.options));

                // Enhance chart for PDF
                chart.options.plugins.title.font.size = 20;
                chart.options.plugins.title.font.weight = 'bold';

                // Make lines thicker and colors more vibrant
                chart.data.datasets.forEach(dataset => {
                    if (dataset.borderWidth) dataset.borderWidth = 4;
                    if (dataset.pointRadius) dataset.pointRadius = 6;
                    if (dataset.pointHoverRadius) dataset.pointHoverRadius = 8;

                    // Enhance colors for better visibility
                    switch(dataset.label) {
                        case 'BP (systolic)':
                            dataset.borderColor = '#dc2626'; 
                            dataset.backgroundColor = 'rgba(220, 38, 38, 0.3)';
                            break;
                        case 'Pulse Rate':
                            dataset.borderColor = '#059669'; 
                            dataset.backgroundColor = 'rgba(5, 150, 105, 0.3)';
                            break;
                        case 'Medications':
                            dataset.backgroundColor = '#7c3aed'; 
                            dataset.borderColor = '#7c3aed';
                            break;
                        case 'Treatments':
                            dataset.backgroundColor = '#ea580c'; 
                            dataset.borderColor = '#ea580c';
                            break;
                    }
                });

                // Update chart
                chart.update('none');

                // Force a small delay to ensure chart renders with new settings
                return new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // Function to restore original chart appearance
        function restoreOriginalChart() {
            const chart = Chart.getChart("progressChart");
            if (chart && window.originalChartOptions) {
                chart.options = window.originalChartOptions;
                chart.data.datasets.forEach(dataset => {
                    // Restore original styles
                    if (dataset.borderWidth) dataset.borderWidth = 2;
                    if (dataset.pointRadius) dataset.pointRadius = 4;
                    if (dataset.pointHoverRadius) dataset.pointHoverRadius = 6;

                    // Restore original colors
                    switch(dataset.label) {
                        case 'BP (systolic)':
                            dataset.borderColor = '#ef4444';
                            dataset.backgroundColor = 'rgba(239,68,68,0.15)';
                            break;
                        case 'Pulse Rate':
                            dataset.borderColor = '#10b981';
                            dataset.backgroundColor = 'rgba(16,185,129,0.12)';
                            break;
                        case 'Medications':
                            dataset.backgroundColor = '#6b21a8';
                            dataset.borderColor = '#6b21a8';
                            break;
                        case 'Treatments':
                            dataset.backgroundColor = '#f97316';
                            dataset.borderColor = '#f97316';
                            break;
                    }
                });
                chart.update();
            }
        }

        // Function to enhance elements in cloned document
        function enhanceElementsForPDF(clonedDoc) {
            // Make text bolder and more visible
            const textElements = clonedDoc.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, td, th');
            textElements.forEach(el => {
                const style = window.getComputedStyle(el);
                const currentWeight = style.fontWeight;
                if (parseInt(currentWeight) < 600) {
                    el.style.fontWeight = '600';
                }
                el.style.color = '#000000'; 
            });

            // Enhance table borders
            const tables = clonedDoc.querySelectorAll('table');
            tables.forEach(table => {
                table.style.border = '2px solid #000000';
                table.style.borderCollapse = 'collapse';
            });

            const tableCells = clonedDoc.querySelectorAll('td, th');
            tableCells.forEach(cell => {
                cell.style.border = '1px solid #666666';
                cell.style.padding = '8px';
                cell.style.backgroundColor = '#ffffff';
            });

            // Enhance chart container
            const chartContainer = clonedDoc.querySelector('.chart-card');
            if (chartContainer) {
                chartContainer.style.border = '2px solid #333333';
                chartContainer.style.backgroundColor = '#ffffff';
                chartContainer.style.padding = '20px';
            }
        }

        // Function to further enhance canvas quality
        function enhanceCanvasQuality(canvas) {
            const ctx = canvas.getContext('2d');

            // Create a new canvas with the same dimensions
            const enhancedCanvas = document.createElement('canvas');
            enhancedCanvas.width = canvas.width;
            enhancedCanvas.height = canvas.height;
            const enhancedCtx = enhancedCanvas.getContext('2d');

            // Apply image smoothing
            enhancedCtx.imageSmoothingEnabled = true;
            enhancedCtx.imageSmoothingQuality = 'high';

            // Draw the original canvas onto the enhanced one
            enhancedCtx.drawImage(canvas, 0, 0);

            
            return enhancedCanvas;
        }

        // Optional sharpening function (use if images still appear blurry)
        function applySharpening(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // Simple sharpening filter
            for (let i = 0; i < data.length; i += 4) {
                
                data[i] = Math.min(255, data[i] * 1.1);     
                data[i + 1] = Math.min(255, data[i + 1] * 1.1); 
                data[i + 2] = Math.min(255, data[i + 2] * 1.1); 
            }

            ctx.putImageData(imageData, 0, 0);
        }
    </script>

}