@model IEnumerable<ONT_3rdyear_Project.Models.Treatment>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@{
    ViewData["Title"] = "Treatments";
}
@{
    var user = await UserManager.GetUserAsync(User);
    var roles = await UserManager.GetRolesAsync(user);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="~/css/Nurse1Sister/TreatmentsList.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@if (TempData["SuccessMessage"] != null)
{
    <script>
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '@TempData["SuccessMessage"]',
            timer: 2000,
            showConfirmButton: false
        });
    </script>
}


<div class="patients-wrapper">

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <i class="fas fa-user-md"></i>
                Navigation
            </h3>
        </div>
        <nav class="sidebar-nav">
            <a asp-action="Vitals" class="nav-item">
                <i class="fas fa-heartbeat"></i>
                <span>Vitals</span>
            </a>
            <a asp-action="Treatments" class="nav-item active">
                <i class="fas fa-stethoscope"></i>
                <span>Treatments</span>
            </a>
            <a href="@Url.Action(roles.Contains("Nurse") ? "Administered" : "ListAdministered", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-pills"></i>
                <span>Medications</span>
            </a>
            <a asp-action="InstructionList" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Instructions</span>
            </a>
            <a asp-action="Progress" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Progress</span>
            </a>
            <a href="@Url.Action("PatientsList", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Patients</span>
            </a>
            <a href="@Url.Action("Dashboard", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
        </nav>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
    <!-- Floating background elements -->
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <!-- Header Section -->
    <div class="patients-header">
        
                <div class="title-section">
                    <h1 class="page-title">
                        <i class="fas fa-stethoscope"></i>
                        Treatments Management
                    </h1>
                    <p class="page-subtitle">Manage and monitor all patient treatments and medical procedures</p>
                </div>
            @* </div>
        </div> *@
    </div>

    <!-- Main Content -->
    <div class="patients-content">
        <div class="container">
            <!-- Search and Filter Section -->
            <div class="search-section">
                <form method="get" asp-action="Treatments" class="search-form">
                    <div class="row mb-3 w-100">
                       @*  <div class="col-md-4">
                            <input type="text" name="searchPatient" class="form-control" placeholder="🔍 Search by patient name..." />
                        </div> *@
                        <div class="col-md-4 position-relative">
                            <input type="text"
                                    id="realTimeSearch"
                                    name="searchPatient"
                                    class="form-control"
                                    placeholder="🔍 Search by patient name..."
                                    autocomplete="off" />
                            <div class="position-absolute top-50 end-0 translate-middle-y me-2">
                                <div id="searchSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <input type="date" name="fromDate" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" name="toDate" class="form-control" />
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-funnel"></i>
                                Filter
                            </button>
                        </div>
                    </div>

                    
                </form>
            </div>

            <!-- Content with side-by-side layout -->
            <div class="content-with-chart">
               
                    <!-- Treatments Table -->
                    <div class="patients-cards-container">
                        <div class="cards-header">
                            <h3>
                                <i class="fas fa-stethoscope"></i>
                                Treatments Records
                                <small id="results-count" class="text-muted" style="font-size: 0.8rem; margin-left: 0.5rem;">
                                    (@Model.Count() records)
                                </small>
                            </h3>
                            <div class="sort-section" style="display: inline-block; margin-left: 16rem;">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-sort"></i> Sort By
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" asp-action="Treatments" asp-route-sortOrder="@ViewData["NameSortParm"]">
                                                Name @(ViewData["NameSortParm"]?.ToString() == "name_desc" ? "(Z-A)" : "(A-Z)")
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-action="Treatments" asp-route-sortOrder="@ViewData["DateSortParm"]">
                                                Date @(ViewData["DateSortParm"]?.ToString() == "date_desc" ? "(Newest)" : "(Oldest)")
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="header-right">
                                <a asp-action="TreatmentsPdf" class="btn btn-danger pdf-btn">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>Export PDF</span>
                                </a>
                            </div>
                        </div>

                        <div class="table-container" id="searchResults">
                            <table class="patients-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <span class="th-content">
                                                <i class="fas fa-user"></i>
                                                Patient Name
                                            </span>
                                        </th>
                                        <th>
                                            <span class="th-content">
                                                <i class="fas fa-user-md"></i>
                                                Treated By
                                            </span>
                                        </th>
                                        <th>
                                            <span class="th-content">
                                                <i class="fas fa-stethoscope"></i>
                                                Treatment Type
                                            </span>
                                        </th>
                                        <th>
                                            <span class="th-content">
                                                <i class="fas fa-clock"></i>
                                                Treatment Time
                                            </span>
                                        </th>
                                        <th class="text-center">
                                            <span class="th-content">
                                                <i class="fas fa-cog"></i>
                                                Actions
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var treatment in Model)
                                    {
                                        <tr class="patient-row">
                                            <td>
                                                <div class="patient-info">
                                                    <div class="patient-avatar">
                                                        @(treatment.Patient?.FirstName?.Substring(0, 1))@(treatment.Patient?.LastName?.Substring(0, 1))
                                                    </div>
                                                    <div class="patient-details">
                                                        <div class="patient-name">@treatment.Patient?.FirstName @treatment.Patient?.LastName</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <strong>@treatment.User?.FullName</strong>
                                            </td>
                                            <td>
                                                <span class="badge" style="background: rgba(0, 119, 190, 0.1); color: var(--primary-blue); padding: 0.375rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">
                                                    @treatment.TreatmentType
                                                </span>
                                            </td>
                                            <td>
                                                <strong>@treatment.TreatmentDate</strong>
                                            </td>
                                           
                                            <td class="text-center">
                                                
                                                <div class="action-buttons">
                                                    <a asp-action="EditTreatment" asp-route-id="@treatment.TreatmentID" class="action-btn btn-edit" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit Treatment">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a href="javascript:void(0);" class="action-btn delete-btn"
                                                       data-bs-toggle="modal" data-bs-target="#deleteModal"
                                                       data-id="@treatment.TreatmentID"
                                                       data-name="@treatment.Patient?.FirstName @treatment.Patient?.LastName"
                                                       title="Delete Treatment">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                <!-- Chart container on the side -->
                <div class="chart-container">
                    <canvas id="medicationsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete treatment for <strong id="deletePatientName"></strong>? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script>

        // Sidebar functionality
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mainContent = document.getElementById('mainContent');

        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('show');
            sidebarToggle.classList.toggle('open');

            // On desktop, adjust main content margin
            if (window.innerWidth > 768) {
                mainContent.classList.toggle('sidebar-open');
            }
        });

        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');
            sidebarToggle.classList.remove('open');
            mainContent.classList.remove('sidebar-open');
        });

        // Close sidebar on window resize if mobile
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                mainContent.classList.remove('sidebar-open');
            }
        });


    document.addEventListener('DOMContentLoaded', function() {
        let deleteTreatmentId = null;
        let deleteRow = null;

        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                deleteTreatmentId = button.getAttribute('data-id');
                const patientName = button.getAttribute('data-name');

                document.getElementById('deletePatientName').textContent = patientName;
                deleteRow = button.closest('tr');
            });

            confirmDeleteBtn.addEventListener('click', function() {
                if (!deleteTreatmentId) return;

                fetch(`/Nurse/DeleteTreatment/${deleteTreatmentId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        if (deleteRow){
                            const treatmentType = deleteRow.querySelector('td:nth-child(3)').textContent.trim();
                            deleteRow.remove();
                            updateChart(treatmentType);
                        }
                        const modalInstance = bootstrap.Modal.getInstance(deleteModal);
                        modalInstance.hide();

                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Treatment successfully deleted.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        throw new Error('Delete failed');
                    }
                })
                .catch(error => console.error(error));
            });
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



<script>
    // Prepare chart data from your model
    let treatments = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                Model.Select(t => new { t.TreatmentType })
        ));

    // Count treatments by type
    function getTreatmentCounts(treatments) {
        const counts = {};
        treatments.forEach(t => {
            counts[t.TreatmentType] = (counts[t.TreatmentType] || 0) + 1;
        });
        return counts;
    }

    // Build chart
    const treatmentCounts = getTreatmentCounts(treatments);
    const labels = Object.keys(treatmentCounts);
    const data = Object.values(treatmentCounts);

    const ctx = document.getElementById('medicationsChart').getContext('2d');

    // Make chart global so we can update later
       // Enhanced chart configuration
    window.treatmentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Treatments',
                data: data,
                backgroundColor: [
                    '#7FD3FD', '#00A7FE', '#B1E4FF', '#0086CC', '#CBEDFF',
                    '#006498', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
                ],
                borderRadius: 6,
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Treatments by Type',
                    font: { size: 16, weight: 'bold' },
                    padding: { top: 10, bottom: 20 }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 14 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                    grid: { display: false }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });

    // Function to update chart after deleting a treatment
    function updateChart(treatmentType) {
        const chart = window.treatmentChart;
        const index = chart.data.labels.indexOf(treatmentType);

        if (index !== -1) {
            chart.data.datasets[0].data[index]--;
            // Remove label if count becomes 0
            if (chart.data.datasets[0].data[index] === 0) {
                chart.data.labels.splice(index, 1);
                chart.data.datasets[0].data.splice(index, 1);
            }
            chart.update();
        }
    }


            // Real-time search functionality for Treatments
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('realTimeSearch');
            const searchSpinner = document.getElementById('searchSpinner');
            let searchTimeout;

            // Function to perform search
            async function performSearch(searchTerm) {
                try {
                    // Show loading state
                    searchSpinner.classList.remove('d-none');
                    const tableBody = document.querySelector('.patients-table tbody');
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Searching...</td></tr>';

                    // Get current filter values
                    const fromDate = document.querySelector('input[name="fromDate"]').value;
                    const toDate = document.querySelector('input[name="toDate"]').value;
                    const sortOrder = '@ViewData["NameSortParm"]'; // Current sort order

                    // Build query parameters
                    const params = new URLSearchParams({
                        searchPatient: searchTerm,
                        sortOrder: sortOrder
                    });

                    if (fromDate) params.append('fromDate', fromDate);
                    if (toDate) params.append('toDate', toDate);

                    // Make the request to your existing endpoint
                    const response = await fetch(`@Url.Action("Treatments")?${params}`);
                    const text = await response.text();

                    // Extract just the table content from the response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newTableBody = doc.querySelector('.patients-table tbody');
                    const resultsCount = doc.querySelector('#results-count');

                    if (newTableBody) {
                        tableBody.innerHTML = newTableBody.innerHTML;

                        // Update results count if available
                        if (resultsCount) {
                            document.getElementById('results-count').innerHTML = resultsCount.innerHTML;
                        }

                        // Re-attach delete event listeners to new rows
                        attachDeleteListeners();

                        // Update the chart with new data
                        updateChartFromSearch(doc);
                    }

                } catch (error) {
                    console.error('Search error:', error);
                    const tableBody = document.querySelector('.patients-table tbody');
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading results</td></tr>';
                } finally {
                    searchSpinner.classList.add('d-none');
                }
            }

            // Function to update chart from search results
            function updateChartFromSearch(doc) {
                try {
                    // Extract treatment data from the search results
                    const treatmentRows = doc.querySelectorAll('.patients-table tbody tr');
                    const treatmentTypes = [];

                    treatmentRows.forEach(row => {
                        const treatmentTypeCell = row.querySelector('td:nth-child(3)');
                        if (treatmentTypeCell) {
                            const badge = treatmentTypeCell.querySelector('.badge');
                            if (badge) {
                                treatmentTypes.push(badge.textContent.trim());
                            }
                        }
                    });

                    // Count treatments by type
                    const treatmentCounts = {};
                    treatmentTypes.forEach(type => {
                        treatmentCounts[type] = (treatmentCounts[type] || 0) + 1;
                    });

                    // Update the chart
                    const chart = window.treatmentChart;
                    chart.data.labels = Object.keys(treatmentCounts);
                    chart.data.datasets[0].data = Object.values(treatmentCounts);
                    chart.update();

                } catch (error) {
                    console.error('Chart update error:', error);
                }
            }

            // Function to re-attach delete listeners after search
            function attachDeleteListeners() {
                const deleteButtons = document.querySelectorAll('.delete-btn');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // Your existing delete modal logic will handle this
                        // since it uses event delegation on document load
                    });
                });
            }

            // Event listener for input with debouncing
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim();

                    // Clear previous timeout
                    clearTimeout(searchTimeout);

                    // Set new timeout (400ms delay for better performance)
                    searchTimeout = setTimeout(() => {
                        if (searchTerm.length === 0 || searchTerm.length >= 2) {
                            performSearch(searchTerm);
                        } else if (searchTerm.length === 0) {
                            // If search is cleared, reload the original page
                            window.location.href = '@Url.Action("Treatments")';
                        }
                    }, 400);
                });

                // Handle Enter key for immediate search
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(searchTimeout);
                        performSearch(e.target.value.trim());
                        e.preventDefault(); // Prevent form submission
                    }
                });

                // Clear search when escape is pressed
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        e.target.value = '';
                        clearTimeout(searchTimeout);
                        window.location.href = '@Url.Action("Treatments")';
                    }
                });
            }
        });
</script>
