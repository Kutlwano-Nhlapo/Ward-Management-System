@model IEnumerable<ONT_3rdyear_Project.ViewModels.AdministerMedicationViewModel>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@{
    ViewData["Title"] = "Administered Medication";
}
@{
    var user = await UserManager.GetUserAsync(User);
    var roles = await UserManager.GetRolesAsync(user);
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="~/css/Nurse1Sister/scheduled.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

@if (TempData["SuccessMessage"] != null)
{
    <script>
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '@TempData["SuccessMessage"]',
            timer: 2000,
            showConfirmButton: false
        });
    </script>
}
@if (TempData["ErrorMessage"] != null)
{
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: '@TempData["ErrorMessage"]',
        confirmButtonColor: '#d33',
        confirmButtonText: 'OK'
    });
</script>
}

<style>
    /* CSS Variables matching VitalsList.css */
    

</style>



<div class="patients-wrapper">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <i class="fas fa-user-md"></i>
                Navigation
            </h3>
        </div>
        <nav class="sidebar-nav">
            <a asp-controller ="Nurse" asp-action="Vitals" class="nav-item">
                <i class="fas fa-heartbeat"></i>
                <span>Vitals</span>
            </a>
            <a asp-controller="Nurse" asp-action="Treatments" class="nav-item">
                <i class="fas fa-stethoscope"></i>
                <span>Treatments</span>
            </a>
            <a href="@Url.Action(roles.Contains("Nurse") ? "Administered" : "ListAdministered", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item active">
                <i class="fas fa-pills"></i>
                <span>Medications</span>
            </a>
            <a asp-controller="Nurse" asp-action="InstructionList" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Instructions</span>
            </a>
            <a asp-controller="Nurse" asp-action="Progress" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Progress</span>
            </a>
            <a href="@Url.Action("PatientsList", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Patients</span>
            </a>
            <a href="@Url.Action("Dashboard", roles.Contains("Nurse") ? "Nurse" : "NurseSister")" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
        </nav>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Floating background elements -->
        <div class="floating-elements">
            <div class="floating-element"></div>
            <div class="floating-element"></div>
            <div class="floating-element"></div>
        </div>

        <!-- Header Section -->
        <div class="patients-header">
            
                    <div class="title-section">
                        <h1 class="page-title">
                            <i class="fas fa-pills"></i>
                            Administered Medication
                        </h1>
                        <p class="page-subtitle">Track and manage all administered medications with comprehensive analytics</p>
                    </div>
                
        </div>

        <!-- Main Content -->
        <div class="patients-content">
            <div class="container">
                @if (Model != null && Model.Any())
                {
                    <!-- Search and Filter Section -->
                    <div class="search-section">
                        <form method="get" asp-action="ListAdministered" class="search-form">
                            <div class="row mb-3 w-100">
                                @* <div class="col-md-4">
                                    <input type="text" name="searchPatient" class="form-control" placeholder="🔍 Search by patient name..." value="@ViewContext.HttpContext.Request.Query["searchPatient"]" />
                                </div> *@
                                <div class="col-md-4 position-relative">
                                    <input type="text"
                                           id="realTimeSearch"
                                           name="searchPatient"
                                           class="form-control"
                                           placeholder="🔍 Search by patient name..."
                                           value="@ViewContext.HttpContext.Request.Query["searchPatient"]"
                                           autocomplete="off" />
                                    <div class="position-absolute top-50 end-0 translate-middle-y me-2">
                                        <div id="searchSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" name="fromDate" class="form-control" value="@ViewContext.HttpContext.Request.Query["fromDate"]" />
                                </div>
                                <div class="col-md-3">
                                    <input type="date" name="toDate" class="form-control" value="@ViewContext.HttpContext.Request.Query["toDate"]" />
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-funnel"></i>
                                        Filter
                                    </button>
                                </div>
                            </div>

                          
                        </form>
                    </div>

                    <!-- Content with side-by-side layout -->
                    <div class="content-with-chart">
                        
                        <!-- Administered Medications Table -->
                        <div class="patients-cards-container">
                            <div class="cards-header">
                                <h3>
                                    <i class="fas fa-pills"></i>
                                    Administered Medications
                                    <small id="results-count" class="text-muted" style="font-size: 0.8rem; margin-left: 0.5rem;">
                                        (@Model.Count() records)
                                    </small>
                                </h3>
                                <div class="sort-section" style="display: inline-block; margin-left: 16rem;">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-sort"></i> Sort By
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" asp-action="ListAdministered" asp-route-sortOrder="@ViewData["NameSortParm"]">
                                                    Name @(ViewData["NameSortParm"]?.ToString() == "name_desc" ? "(Z-A)" : "(A-Z)")
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" asp-action="ListAdministered" asp-route-sortOrder="@ViewData["DateSortParm"]">
                                                    Date @(ViewData["DateSortParm"]?.ToString() == "date_desc" ? "(Newest)" : "(Oldest)")
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="header-right">
                                    <a asp-action="AdministeredPdf" class="btn btn-danger pdf-btn">
                                        <i class="fas fa-file-pdf"></i>
                                        <span>Export PDF</span>
                                    </a>
                                </div>
                            </div>

                            <div class="table-container" id="searchResults">
                                <table class="patients-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-user"></i>
                                                    Patient Name
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-pills"></i>
                                                    Medication
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-prescription-bottle"></i>
                                                    Dosage
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-calendar"></i>
                                                    Date Administered
                                                </span>
                                            </th>
                                            <th>
                                                <span class="th-content">
                                                    <i class="fas fa-file-prescription"></i>
                                                    Prescription
                                                </span>
                                            </th>
                                            <th class="text-center">
                                                <span class="th-content">
                                                    <i class="fas fa-cog"></i>
                                                    Actions
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var medication in Model)
                                        {
                                            <tr class="patient-row">
                                                <td>
                                                    <div class="patient-info">
                                                        <div class="patient-avatar">
                                                            @(medication.PatientName?.Substring(0, 1))
                                                        </div>
                                                        <div class="patient-details">
                                                            <div class="patient-name">@medication.PatientName</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <strong>@medication.MedicationName</strong>
                                                </td>
                                                <td>
                                                    <strong>@medication.Dosage</strong>
                                                </td>
                                                <td>
                                                    <strong>@medication.AdministeredDate.ToShortDateString()</strong>
                                                </td>
                                                <td>
                                                    @if (medication.HasPrescription)
                                                    {
                                                        <a asp-action="DownloadPrescription" asp-route-id="@medication.PrescriptionId" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-download"></i>
                                                            @* Download PDF *@
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <div class="action-buttons">
                                                        <a asp-action="EditAdministered" asp-route-id="@medication.Id" class="action-btn btn-treatment" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit Medication" data-has-prescription="@(medication.PrescriptionId != null ? "true" : "false")">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <button class="action-btn delete-btn" data-id="@medication.Id" data-name="@medication.PatientName" data-bs-toggle="modal" data-bs-target="#deleteMedicationModal" title="Delete Medication">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Chart container on the side -->
                        <div class="chart-container">
                            <h2>
                                <i class="bi bi-bar-chart-fill"></i>
                                Medication Analytics
                            </h2>
                            <canvas id="medicationsChart"></canvas>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle"></i>
                        No administered medications available.
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteMedicationModal" tabindex="-1" aria-labelledby="deleteMedicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMedicationModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this medication record for <strong id="deletePatientName"></strong>? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <form method="post" asp-action="DeleteAdminister" asp-controller="NurseSister">
                    <input type="hidden" id="deleteMedicationId" name="id" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i>
                        Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


 <script>


    // Sidebar functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const mainContent = document.getElementById('mainContent');

    sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('show');
        sidebarToggle.classList.toggle('open');

        // On desktop, adjust main content margin
        if (window.innerWidth > 768) {
            mainContent.classList.toggle('sidebar-open');
        }
    });

    sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('show');
        sidebarToggle.classList.remove('open');
        mainContent.classList.remove('sidebar-open');
    });

    // Close sidebar on window resize if mobile
    window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
            mainContent.classList.remove('sidebar-open');
        }
    });

    // Delete modal functionality
    var deleteMedicationModal = document.getElementById('deleteMedicationModal');

    deleteMedicationModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var id = button.getAttribute('data-id');
        var name = button.getAttribute('data-name');

        document.getElementById('deleteMedicationId').value = id;
        document.getElementById('deletePatientName').textContent = name;
    });

    // Enhanced medications chart
    document.addEventListener("DOMContentLoaded", function () {
        var medications = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
             Model.Select(m => m.MedicationName).ToList()
        ));

        var counts = {};
        medications.forEach(function (med) {
            counts[med] = (counts[med] || 0) + 1;
        });

        var ctx = document.getElementById('medicationsChart').getContext('2d');

        // Enhanced color palette for medications
        const medicationColors = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
            '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1',
            '#A855F7', '#F43F5E', '#14B8A6', '#FACC15'
        ];

        window.medicationsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    label: 'Times Administered',
                    data: Object.values(counts),
                    backgroundColor: Object.keys(counts).map((_, i) =>
                        medicationColors[i % medicationColors.length]),
                    borderRadius: 6,
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Most Administered Medications',
                        font: { size: 16, weight: 'bold' },
                        padding: { top: 10, bottom: 20 }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y} time${context.parsed.y !== 1 ? 's' : ''}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        title: {
                            display: true,
                            text: 'Times Administered'
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
    });

        document.addEventListener('DOMContentLoaded', function() {
        // Add click event listeners to all edit buttons
        const editButtons = document.querySelectorAll('a[href*="EditAdministered"]');

        editButtons.forEach(button => {
            button.addEventListener('click', async function(e) {
                // You could check here if the medication has a prescription
                // and prevent the default action if it does
                const hasPrescription = this.getAttribute('data-has-prescription') === 'true';

                if (hasPrescription) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'error',
                        title: 'Cannot Edit',
                        text: 'You cannot edit prescribed medication.',
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });
    });

       
</script>

<script>
     // Real-time search functionality for Medications - CORRECTED VERSION
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('realTimeSearch');
        const searchSpinner = document.getElementById('searchSpinner');
        let searchTimeout;

        // Function to perform search
        async function performSearch(searchTerm) {
            try {
                // Show loading state
                if (searchSpinner) searchSpinner.classList.remove('d-none');
                const tableBody = document.querySelector('.patients-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Searching...</td></tr>';
                }

                // Get current filter values
                const fromDate = document.querySelector('input[name="fromDate"]')?.value || '';
                const toDate = document.querySelector('input[name="toDate"]')?.value || '';
                const sortOrder = '@ViewData["NameSortParm"]' || '';

                // Build query parameters
                const params = new URLSearchParams({
                    searchPatient: searchTerm,
                    sortOrder: sortOrder
                });

                if (fromDate) params.append('fromDate', fromDate);
                if (toDate) params.append('toDate', toDate);

                // Make the request to your existing endpoint
                const response = await fetch(`@Url.Action("ListAdministered")?${params}`);

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const text = await response.text();

                // Extract just the table content from the response
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const newTableBody = doc.querySelector('.patients-table tbody');
                const resultsCount = doc.querySelector('#results-count');

                if (newTableBody && tableBody) {
                    tableBody.innerHTML = newTableBody.innerHTML;

                    // Update results count if available
                    if (resultsCount) {
                        const existingResultsCount = document.getElementById('results-count');
                        if (existingResultsCount) {
                            existingResultsCount.innerHTML = resultsCount.innerHTML;
                        }
                    }

                    // Re-attach event listeners to new rows
                    attachEventListeners();

                    // Update the chart with new data
                    updateChartFromSearch(doc);
                }

            } catch (error) {
                console.error('Search error:', error);
                const tableBody = document.querySelector('.patients-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading results</td></tr>';
                }
            } finally {
                if (searchSpinner) searchSpinner.classList.add('d-none');
            }
        }

        // Function to update chart from search results
        function updateChartFromSearch(doc) {
            try {
                // Extract medication data from the search results
                const medicationRows = doc.querySelectorAll('.patients-table tbody tr');
                const medicationNames = [];

                medicationRows.forEach(row => {
                    const medicationCell = row.querySelector('td:nth-child(2)'); // Medication name column
                    if (medicationCell) {
                        const medicationName = medicationCell.textContent.trim();
                        if (medicationName && medicationName !== 'Searching...' && !medicationName.includes('Error')) {
                            medicationNames.push(medicationName);
                        }
                    }
                });

                // Count medications by name
                const medicationCounts = {};
                medicationNames.forEach(name => {
                    medicationCounts[name] = (medicationCounts[name] || 0) + 1;
                });

                // Update the chart
                const chart = window.medicationsChart;
                if (chart && Object.keys(medicationCounts).length > 0) {
                    chart.data.labels = Object.keys(medicationCounts);
                    chart.data.datasets[0].data = Object.values(medicationCounts);
                    chart.update();
                }

            } catch (error) {
                console.error('Chart update error:', error);
            }
        }

        // Function to re-attach event listeners after search
        function attachEventListeners() {
            // Re-attach delete modal listeners
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // The existing delete modal logic will handle this
                });
            });

            // Re-attach edit button listeners
            const editButtons = document.querySelectorAll('a[href*="EditAdministered"]');
            editButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    const hasPrescription = this.getAttribute('data-has-prescription') === 'true';
                    if (hasPrescription) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Cannot Edit',
                            text: 'You cannot edit prescribed medication.',
                            confirmButtonColor: '#d33',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
        }

        // Event listener for input with debouncing
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.trim();

                // Clear previous timeout
                clearTimeout(searchTimeout);

                // Set new timeout (400ms delay for better performance)
                searchTimeout = setTimeout(() => {
                    if (searchTerm.length === 0 || searchTerm.length >= 2) {
                        performSearch(searchTerm);
                    } else if (searchTerm.length === 0) {
                        // If search is cleared, reload the original page
                        window.location.href = '@Url.Action("ListAdministered")';
                    }
                }, 400);
            });

            // Optional: Handle Enter key for immediate search
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    performSearch(e.target.value.trim());
                    e.preventDefault(); // Prevent form submission
                }
            });

            // Clear search when escape is pressed
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    e.target.value = '';
                    clearTimeout(searchTimeout);
                    window.location.href = '@Url.Action("ListAdministered")';
                }
            });
        }

        // Initial attachment of event listeners
        attachEventListeners();
    });
</script>

