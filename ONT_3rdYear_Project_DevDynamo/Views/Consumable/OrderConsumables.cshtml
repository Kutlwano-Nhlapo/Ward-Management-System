@using System.Collections
@model ONT_3rdyear_Project.Models.Order
@{
    ViewData["Title"] = "Request Consumables";
    int index = 0;
}

<head>
    <link href="/css/Script&Consumable/Consumable.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include Bootstrap JS (if not already on layout) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

   
</head>

<div class="dashboard-wrapper">
    <div class="container">
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <h1><i class="bi bi-moisture"></i> Order Consumable</h1>
                <div class="d-flex gap-2">
                    <a asp-controller="Consumable" asp-action="Dashboard" class="back-button">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>

        <div class="order-page">
            <!-- =================== LEFT FORM =================== -->
            <div class="form-section">
               
                    <form asp-action="OrderConsumables" id="RequestItemsTable" method="post" class="mb-3 width-100">
                        <div class="mb-3 wid">
                            <label for="wardSelect" class="ward-badge">Select Ward</label>
                            <select id="wardSelect" asp-for="WardID" asp-items="ViewBag.Wards" class="form-select ward">
                                <option value="">-- Select Ward --</option>
                            </select>
                        </div>
                <div class="table-responsive">
                    <table class="table orders-table mb-0">    
                            <thead>
                                <tr>
                                    <th>Consumable</th>
                                    <th>Quantity</th>
                                    <th>Reason</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="RequestItemsTableBody">
                                @foreach (var order in Model.ConsumableOrders)
                                {
                                    <tr>
                                        <td>
                                            <select name="ConsumableOrders[@index].ConsumableId" id="consumableSelect" asp-items="ViewBag.Consumables" class="form-control">
                                                <option value="">-- Select Consumable --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input name="ConsumableOrders[@index].QuantityRequested" class="form-control" value="@order.QuantityRequested" />
                                        </td>
                                        <td>
                                           
                                            <select name="ConsumableOrders[@index].Reason" class="form-control">
                                                <option value="">-- Select Reason --</option>
                                                <option value="Restocking">Restocking</option>
                                                <option value="Emergency Use">Emergency Use</option>
                                                <option value="New Stock">New Stock</option>
                                                <option value="Damaged">Damaged</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </td>
                                        <td>
                                            <button type="button" class="action-btn remove">Remove</button>
                                        </td>
                                    </tr>
                                    index++;
                                }
                            </tbody>
                        </table>

                        <div class="wid">
                            <label class="ward-badge"><i class="bi bi-clipboard-pulse"></i> Remarks</label>
                            <textarea asp-for="Remark" class="form-control"></textarea>
                            <span asp-validation-for="Remark" class="text-danger"></span>
                        </div>

                        <button type="button" class="action-btn primary mt-3" id="AddBtnRow">Add Item</button>
                        <button type="submit" class="action-btn success mt-3">Submit Request</button>
                    </form>
                </div>
            </div>

            <!-- =================== RIGHT SIDEBAR =================== -->
            <div class="sidebar">
                <div class="summary-card">
                    <h3>🧾 Order Summary</h3>
                    <p><strong>Items Added:</strong> <span id="itemCount">0</span></p>
                    <p><strong>Total Quantity:</strong> <span id="totalQuantity">0</span></p>
                    <button id="viewDetailsBtn" class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#detailsModal">
                        View Details
                    </button>
                </div>

                <div class="tips-card">
                    <h4>💡 Tips</h4>
                    <ul>
                        <li>Ensure quantities are correct.</li>
                        <li>Only submit once all fields are filled.</li>
                        <li>Double-check consumable types per ward.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- =================== MODAL =================== -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Order Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table orders-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Consumable</th>
                            <th>Quantity</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="detailsTableBody">
                        <tr><td colspan="4" class="text-center text-muted">No items added yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const AddBtnRow = document.getElementById("AddBtnRow");
            const TBody = document.getElementById("RequestItemsTableBody");
            const detailsTableBody = document.getElementById("detailsTableBody");

            // === Fetch consumables dynamically ===
            $('#wardSelect').change(function () {
                const wardId = $(this).val();
                $('#consumableSelect').empty().append('<option>Loading...</option>');
                $.getJSON('/Consumable/RequestConsumablesByWard', { wardId: wardId }, function (data) {
                    $('#consumableSelect').empty().append('<option value="">-- Select Consumable --</option>');
                    data.forEach(item => {
                        $('#consumableSelect').append(`<option value="${item.consumableId}">${item.name}</option>`);
                    });
                });
            });

            // === Add new row ===
            AddBtnRow.addEventListener("click", () => {
                const RowCount = TBody.rows.length;
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>
                        <select id="consumableSelect" name="ConsumableOrders[${RowCount}].ConsumableId" class="form-control">
                            ${document.getElementById("consumableSelect").innerHTML}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="ConsumableOrders[${RowCount}].QuantityRequested" class="form-control" value="0" min="0"/>
                    </td>
                    <td>
                        <select name="ConsumableOrders[${RowCount}].Reason" class="form-control">
                            <option value="">-- Select Reason --</option>
                            <option value="Restocking">Restocking</option>
                            <option value="Emergency Use">Emergency Use</option>
                            <option value="New Stock">New Stock</option>
                            <option value="Damaged">Damaged</option>
                            <option value="Other">Other</option>
                        </select>
                        
                    </td>
                    <td>
                        <button type="button" class="action-btn remove">Remove</button>
                    </td>
                `;
                TBody.appendChild(row);

                row.querySelector(".removeRowBtn").addEventListener("click", () => {
                    row.remove();
                    updateRowIndices();
                    updateSidebarSummary();
                });

                updateConsumableOptions();
                updateSidebarSummary();
            });

            // === Maintain index consistency ===
            function updateRowIndices() {
                const rows = TBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.querySelectorAll('input, select').forEach(input => {
                        const name = input.getAttribute('name');
                        if (name) {
                            const newName = name.replace(/\[\d+\]/, `[${index}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                });
            }

            // === Prevent duplicate consumables ===
            function updateConsumableOptions() {
                const selectedValues = Array.from(TBody.querySelectorAll('select[name*="ConsumableId"]'))
                    .map(sel => sel.value)
                    .filter(val => val);

                TBody.querySelectorAll('select[name*="ConsumableId"]').forEach(select => {
                    const currentValue = select.value;
                    Array.from(select.options).forEach(opt => {
                        if (opt.value === "" || opt.value === currentValue) {
                            opt.disabled = false;
                        } else {
                            opt.disabled = selectedValues.includes(opt.value);
                        }
                    });
                });
            }

            // === Sidebar Updates ===
            function flashUpdate(id) {
                const el = document.getElementById(id);
                el.classList.add("updated");
                setTimeout(() => el.classList.remove("updated"), 400);
            }

            function updateSidebarSummary() {
                const rows = TBody.querySelectorAll("tr");
                const itemCount = rows.length;
                let totalQuantity = 0;

                rows.forEach(row => {
                    const qtyInput = row.querySelector('input[name*="QuantityRequested"]');
                    if (qtyInput && qtyInput.value) {
                        totalQuantity += parseInt(qtyInput.value) || 0;
                    }
                });

                document.getElementById("itemCount").textContent = itemCount;
                document.getElementById("totalQuantity").textContent = totalQuantity;
                flashUpdate("itemCount");
                flashUpdate("totalQuantity");
            }

            // === Update modal table ===
            function updateDetailsModal() {
                const rows = TBody.querySelectorAll("tr");
                if (rows.length === 0) {
                    detailsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No items added yet.</td></tr>`;
                    return;
                }

                detailsTableBody.innerHTML = "";
                rows.forEach((row, i) => {
                    const consumable = row.querySelector('select[name*="ConsumableId"] option:checked')?.textContent || "--";
                    const quantity = row.querySelector('input[name*="QuantityRequested"]').value || "0";
                    const reason = row.querySelector('input[name*="Reason"]').value || "-";

                    const newRow = document.createElement("tr");
                    newRow.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${consumable}</td>
                        <td>${quantity}</td>
                        <td>${reason}</td>
                    `;
                    detailsTableBody.appendChild(newRow);
                });
            }

            // Update modal every time it opens
            document.getElementById("detailsModal").addEventListener("show.bs.modal", updateDetailsModal);

            // Quantity listener
            TBody.addEventListener("input", (e) => {
                if (e.target.name.includes("QuantityRequested")) {
                    updateSidebarSummary();
                }
            });

            updateSidebarSummary();
        });
    </script>
}
